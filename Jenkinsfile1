def imageTag = ""

pipeline {
    agent any

    environment {
        DOCKER_HUB_CREDS = credentials('DOCKERHUB_TOKEN')
        DOCKER_IMAGE = "ptn3001/"
        NAMESPACE = "staging"
    }

    stages {
        stage('Check Branch or Tag') {
            steps {
                script {
                    def branch = env.BRANCH_NAME
                    if (branch ==~ /^v\d+\.\d+\.\d+$/) {
                        echo "This is a tag release: ${branch}"
                        imageTag = branch
                    } else if (branch ==~ /^rc_v\d+\.\d+\.\d+$/) {
                        echo "This is a release candidate branch: ${branch}"
                        imageTag = branch.replaceFirst(/^rc_/, '')
                    } else {
                        echo "Not a release/tag branch. Skipping pipeline."
                        currentBuild.result = 'ABORTED'
                        return
                    }
                }
            }
        }

        stage('Build & Push Image') {
            steps {
                script {
                    sh './mvnw clean install -P buildDocker'

                    def services = [
                        'spring-petclinic-admin-server',
                        'spring-petclinic-api-gateway',
                        'spring-petclinic-config-server',
                        'spring-petclinic-customers-service',
                        'spring-petclinic-discovery-server',
                        'spring-petclinic-vets-service',
                        'spring-petclinic-visits-service',
                        'spring-petclinic-genai-service',
                    ]

                    sh "echo ${DOCKER_HUB_CREDS_PSW} | docker login -u ${DOCKER_HUB_CREDS_USR} --password-stdin"

                    for (svc in services) {
                        def img = "${DOCKER_IMAGE}${svc}"
                        sh """
                            docker tag ${img} ${img}:${imageTag}
                            docker push ${img}:${imageTag}
                        """
                    }
                }
            }
        }

        stage('Create Namespace if needed') {
            steps {
                script {
                    sh "kubectl get namespace ${NAMESPACE} || kubectl create namespace ${NAMESPACE}"
                }
            }
        }

        stage('Deploy to Staging') {
            steps {
                script {
                    sh """
                    helm upgrade --install spring-petclinic ./spring-petclinic -n ${NAMESPACE} --create-namespace \\
                        --set namespace=${NAMESPACE} \\
                        --set services.api-gateway.tag=${imageTag} \\
                        --set services.customers-service.tag=${imageTag} \\
                        --set services.vets-service.tag=${imageTag} \\
                        --set services.visits-service.tag=${imageTag} \\
                        --set services.admin-server.tag=${imageTag} \\
                        --set services.discovery-server.tag=${imageTag} \\
                        --set services.config-server.tag=${imageTag} \\
                        --set services.genai-service.tag=${imageTag}
                    """
                }
            }
        }
        stage('Debug Info') {
            steps {
                script {
                    echo "Running job: ${env.JOB_NAME} on branch ${env.BRANCH_NAME}"
                    sh "cat Jenkinsfile"  // cat chính file Jenkinsfile đang chạy
                }
            }
        }
    }

    post {
        success {
            echo "Deployed to staging with tag ${imageTag}"
        }
        failure {
            echo "Pipeline failed."
        }
        aborted {
            echo "Pipeline aborted due to invalid branch/tag."
        }
    }
}
