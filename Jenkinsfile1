pipeline {
    agent any

    environment {
        DOCKER_HUB_CREDS = credentials('DOCKERHUB_TOKEN')
        DOCKER_IMAGE = "ptn3001/"
        IMAGE_TAG = ''
    }

    stages {
        stage('Check Branch or Tag') {
            steps {
                script {
                    def branch = env.BRANCH_NAME
                    if (branch ==~ /^v\d+\.\d+\.\d+$/) {
                        echo "This is a tag release: ${branch}"
                        env.IMAGE_TAG = branch
                    } else if (branch ==~ /^rc_v\d+\.\d+\.\d+$/) {
                        echo "This is a release candidate branch: ${branch}"
                        env.IMAGE_TAG = branch.replaceFirst(/^rc_/, '')
                    } else {
                        echo "Not a release/tag branch. Skipping pipeline."
                        currentBuild.result = 'ABORTED'
                        return
                    }
                }
            }
        }
    }

    post {
        success {
            echo "Deployed to staging with tag ${env.IMAGE_TAG}"
        }
        failure {
            echo "Pipeline failed."
        }
        aborted {
            echo "Pipeline aborted due to invalid branch/tag."
        }
    }
}
